<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Select2</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h2>Test Select2 Product Search</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="produit">Produit</label>
                    <select class="form-control" id="produit">
                        <option value="">Rechercher un produit...</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <button type="button" class="btn btn-primary" id="test-api">Test API Direct</button>
        </div>
        
        <div class="mt-3">
            <h4>Debug Output:</h4>
            <pre id="debug-output"></pre>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
    $(document).ready(function() {
        var debugOutput = $('#debug-output');
        
        function log(message) {
            console.log(message);
            debugOutput.append(JSON.stringify(message, null, 2) + '\n');
        }
        
        log('Page loaded');
        
        // Test API directly
        $('#test-api').click(function() {
            log('Testing API directly...');
            $.ajax({
                url: '/bikorwahost/Bikorwa/src/api/produits/get_produits.php?with_stock=true',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    log('API Success:');
                    log(data);
                },
                error: function(xhr, status, error) {
                    log('API Error:');
                    log({
                        status: status,
                        error: error,
                        responseText: xhr.responseText
                    });
                }
            });
        });
        
        // Initialize Select2
        $('#produit').select2({
            theme: 'bootstrap-5',
            placeholder: 'Rechercher un produit...',
            allowClear: true,
            minimumInputLength: 0,
            ajax: {
                url: '/bikorwahost/Bikorwa/src/api/produits/get_produits.php',
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    log('Select2 AJAX request: ' + JSON.stringify(params));
                    return {
                        search: params.term || '',
                        page: params.page || 1,
                        with_stock: true
                    };
                },
                processResults: function(data, params) {
                    log('Select2 AJAX response:');
                    log(data);
                    params.page = params.page || 1;
                    
                    if (data && data.success) {
                        return {
                            results: $.map(data.produits, function(produit) {
                                return {
                                    id: produit.id,
                                    text: produit.nom + ' - ' + produit.code + ' (Stock: ' + produit.quantite_stock + ')'
                                };
                            }),
                            pagination: {
                                more: (params.page * 10) < (data.total_count || 0)
                            }
                        };
                    } else {
                        log('API Error: ' + (data ? data.message : 'No data received'));
                        return {
                            results: []
                        };
                    }
                },
                cache: false
            }
        });
        
        log('Select2 initialized');
    });
    </script>
</body>
</html>
